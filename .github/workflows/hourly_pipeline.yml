name: Hourly AQ Pipeline (Ingest -> Features -> Predict)

on:
  schedule:
    - cron: "0 * * * *"   # every hour (UTC)
  workflow_dispatch:

jobs:
  run-hourly:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ingest raw data
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          python 01_ingest_raw_karachi.py

      - name: Build features
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          python 02_build_features_pm25_next1h.py

      - name: Fetch latest model from MongoDB
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          python - << 'PY'
          import os
          from pymongo import MongoClient
          from pathlib import Path

          uri = os.environ["MONGO_URI"]
          client = MongoClient(uri)
          db = client["feature_store"]
          col = db["model_registry"]

          doc = col.find_one(sort=[("created_at", -1)])
          if not doc:
            raise RuntimeError("No model found in feature_store.model_registry. Run the Daily Training workflow once.")

          Path("models").mkdir(exist_ok=True)
          out_path = Path("models") / "rf_pm25_next1h.pkl"
          with open(out_path, "wb") as f:
            f.write(doc["model_bytes"])

          print("âœ… Model fetched:", out_path, "created_at:", doc.get("created_at"))
          PY

      - name: Predict and store
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          python 04_predict_and_store_pm25_next1h.py
